<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Announcements - NADI SCSB</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%232228a4'/%3E%3Cpath d='M9 23V9h4l6 9V9h4v14h-4l-6-9v9H9z' fill='white'/%3E%3C/svg%3E" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4" crossorigin="anonymous"></script>
    <style type="text/tailwindcss">
      /* Tailwind CSS v4 theme configuration */
      @layer base {
        :root {
          --color-nadi: #2228a4;
          --color-nadi-hover: #1b1d8a;
          --font-family-sans: "Plus Jakarta Sans", sans-serif;
          --shadow-card: 0 2px 10px -2px rgba(0, 0, 0, 0.05);
        }
      }

      #ssoSubFilter { display: none; }
      #ssoSubFilter:not(.hidden) { display: block; }

      /* Ensure links in announcement content break properly */
      .ann-content-break a {
        word-break: break-all;
        overflow-wrap: anywhere;
      }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script>
      (function () {
        try {
          if (window.top !== window.self) {
            const memory = new Map();
            const shim = {
              getItem(key) {
                return memory.has(key) ? memory.get(key) : null;
              },
              setItem(key, value) {
                memory.set(key, String(value));
              },
              removeItem(key) {
                memory.delete(key);
              }
            };
            Object.defineProperty(window, "localStorage", { value: shim, configurable: true });
            Object.defineProperty(window, "sessionStorage", { value: shim, configurable: true });
          }
        } catch (error) {}
      })();
    </script>
    <script src="js/supabase.js"></script>
  </head>
  <body class="min-h-screen flex flex-col text-slate-800 font-sans bg-slate-50">
    <header class="sticky top-0 z-40 header-bg shadow-md">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a href="index.html" class="flex items-center gap-2 text-white hover:text-slate-200 transition-colors">
            <i class="fa-solid fa-arrow-left"></i>
            <span class="text-xs font-bold">Back</span>
          </a>
          <div class="w-px h-6 bg-white/20"></div>
          <div>
            <h1 class="text-base font-bold leading-tight text-white">Announcements</h1>
            <p class="text-[9px] font-bold text-slate-300 tracking-wider">NADI SCSB</p>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-grow w-full px-4 py-6">
      <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-card border border-slate-200 overflow-hidden">
          <div class="p-4 border-b border-slate-100">
            <div class="flex flex-wrap gap-2">
              <button data-ann-filter="all" onclick="setAnnouncementFilter('all')" class="px-4 py-2 text-xs font-bold rounded-lg transition-colors bg-nadi text-white">All</button>
              <button data-ann-filter="Urgent" onclick="setAnnouncementFilter('Urgent')" class="px-4 py-2 text-xs font-bold rounded-lg transition-colors bg-red-500 text-white hover:bg-red-600">Urgent</button>
              <button data-ann-filter="TP" onclick="setAnnouncementFilter('TP')" class="px-4 py-2 text-xs font-bold rounded-lg transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200">TP</button>
              <button data-ann-filter="Samudra" onclick="setAnnouncementFilter('Samudra')" class="px-4 py-2 text-xs font-bold rounded-lg transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200">Samudra</button>
              <button data-ann-filter="Maxis" onclick="setAnnouncementFilter('Maxis')" class="px-4 py-2 text-xs font-bold rounded-lg transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200">Maxis</button>
              <button data-ann-filter="SSO" onclick="setAnnouncementFilter('SSO')" id="btnFilterSSO" class="px-4 py-2 text-xs font-bold rounded-lg transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200">SSO</button>
            </div>
            <!-- SSO Subcategory Filter -->
            <div id="ssoSubFilter" class="hidden mt-3 pt-3 border-t border-slate-100">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div aria-label="SSO Main Category Filter" class="text-[10px] font-bold text-slate-500 uppercase block mb-1.5">Category</div>
                  <div class="grid grid-cols-1 gap-1">
                    <label class="relative cursor-pointer group">
                      <input type="radio" name="ssoMainFilter" value="Usahawan" onchange="setSSOSubFilter('Usahawan')" class="peer sr-only" />
                      <div class="px-2 py-1 rounded border border-slate-200 hover:bg-yellow-100 text-center transition-all flex items-center justify-center bg-yellow-50 text-yellow-700 border-yellow-200">
                        <span class="text-[9px] font-bold uppercase">Usahawan</span>
                      </div>
                    </label>
                    <label class="relative cursor-pointer group">
                      <input type="radio" name="ssoMainFilter" value="Kesejahteraan Kendiri" onchange="setSSOSubFilter('Kesejahteraan Kendiri')" class="peer sr-only" />
                      <div class="px-2 py-1 rounded border border-slate-200 hover:bg-emerald-50 text-center transition-all flex items-center justify-center bg-emerald-50 text-emerald-700 border-emerald-200">
                        <span class="text-[9px] font-bold uppercase">Kesejahteraan</span>
                      </div>
                    </label>
                    <label class="relative cursor-pointer group">
                      <input type="radio" name="ssoMainFilter" value="Kesedaran" onchange="setSSOSubFilter('Kesedaran')" class="peer sr-only" />
                      <div class="px-2 py-1 rounded border border-slate-200 hover:bg-violet-50 text-center transition-all flex items-center justify-center bg-violet-50 text-violet-700 border-violet-200">
                        <span class="text-[9px] font-bold uppercase">Kesedaran</span>
                      </div>
                    </label>
                    <label class="relative cursor-pointer group">
                      <input type="radio" name="ssoMainFilter" value="Inisiatif Kerajaan" onchange="setSSOSubFilter('Inisiatif Kerajaan')" class="peer sr-only" />
                      <div class="px-2 py-1 rounded border border-slate-200 hover:bg-red-50 text-center transition-all flex items-center justify-center bg-red-50 text-red-700 border-red-200">
                        <span class="text-[9px] font-bold uppercase">Kerajaan</span>
                      </div>
                    </label>
                    <label class="relative cursor-pointer group">
                      <input type="radio" name="ssoMainFilter" value="Pembelajaran Sepanjang Hayat" onchange="setSSOSubFilter('Pembelajaran Sepanjang Hayat')" class="peer sr-only" />
                      <div class="px-2 py-1 rounded border border-slate-200 hover:bg-blue-50 text-center transition-all flex items-center justify-center bg-blue-50 text-blue-700 border-blue-200">
                        <span class="text-[9px] font-bold uppercase">Pembelajaran Sepanjang Hayat</span>
                      </div>
                    </label>
                  </div>
                </div>
                <div id="ssoSubSubFilter" class="hidden">
                  <div aria-label="SSO Sub-Subcategory Filter" class="text-[10px] font-bold text-slate-500 uppercase block mb-1.5">Subcategory</div>
                  <div id="ssoSubSubFilterContainer" class="grid grid-cols-2 gap-1"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-end">
            <button onclick="annShowAddForm()" class="px-4 py-2 bg-nadi hover:bg-[#1b1d8a] text-white text-xs font-bold rounded-lg shadow transition-colors flex items-center gap-2">
              <i class="fa-solid fa-plus-circle"></i> Add Announcement
            </button>
          </div>

          <div class="p-4 border-b border-slate-200 bg-white">
            <div class="relative">
              <input
                type="text"
                id="announcementSearch"
                placeholder="Search announcements..."
                class="w-full pl-9 pr-9 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-nadi"
                oninput="annHandleSearch(this.value)"
              />
              <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
              <button
                id="announcementSearchClear"
                onclick="annClearSearch()"
                class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"
              >
                <i class="fa-solid fa-xmark text-sm"></i>
              </button>
            </div>
          </div>

          <div id="announcementListContainer" class="p-4 space-y-4">
            <p class="text-sm text-slate-400 text-center py-8">Loading announcements...</p>
          </div>
        </div>
      </div>
    </main>

    <div id="addForm" class="hidden fixed top-20 right-4 w-[92vw] max-w-md bg-white rounded-xl shadow-xl border border-slate-200 z-50 overflow-hidden">
      <div class="px-5 py-4 bg-nadi flex justify-between items-center">
        <h3 class="text-sm font-bold text-white">Create Announcement</h3>
        <button onclick="annHideAddForm()" class="w-6 h-6 rounded-full bg-white/20 hover:bg-white/30 text-white flex items-center justify-center transition-colors">
          <i class="fa-solid fa-xmark text-xs"></i>
        </button>
      </div>
      <div class="p-5 space-y-4 max-h-[calc(100vh-180px)] overflow-y-auto">
        <div>
          <label for="announcementTitle" class="sr-only">Title</label>
          <input type="text" id="announcementTitle" name="announcementTitle" autocomplete="off" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-nadi" placeholder="Title..." />
        </div>
        <div class="grid grid-cols-5 gap-1">
          <label class="relative cursor-pointer group">
            <input type="radio" id="annCategoryUrgent" name="annCategory" value="Urgent" onchange="annCategoryChanged()" class="peer sr-only" />
            <div class="px-2 py-1 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-red-700 peer-checked:border-red-400 peer-checked:bg-red-50 text-center transition-all flex items-center justify-center">
              <span class="text-[9px] font-bold uppercase">Urgent</span>
            </div>
          </label>
          <label class="relative cursor-pointer group">
            <input type="radio" id="annCategoryTP" name="annCategory" value="TP" onchange="annCategoryChanged()" class="peer sr-only" />
            <div class="px-2 py-1 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-slate-600 peer-checked:border-slate-400 peer-checked:bg-slate-100 text-center transition-all flex items-center justify-center">
              <span class="text-[9px] font-bold uppercase">TP</span>
            </div>
          </label>
          <label class="relative cursor-pointer group">
            <input type="radio" id="annCategorySamudra" name="annCategory" value="Samudra" onchange="annCategoryChanged()" class="peer sr-only" />
            <div class="px-2 py-1 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-cyan-700 peer-checked:border-cyan-400 peer-checked:bg-cyan-50 text-center transition-all flex items-center justify-center">
              <span class="text-[9px] font-bold uppercase">Samudra</span>
            </div>
          </label>
          <label class="relative cursor-pointer group">
            <input type="radio" id="annCategoryMaxis" name="annCategory" value="Maxis" onchange="annCategoryChanged()" class="peer sr-only" />
            <div class="px-2 py-1 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-rose-700 peer-checked:border-rose-400 peer-checked:bg-rose-50 text-center transition-all flex items-center justify-center">
              <span class="text-[9px] font-bold uppercase">Maxis</span>
            </div>
          </label>
          <label class="relative cursor-pointer group">
            <input type="radio" id="annCategorySSO" name="annCategory" value="SSO" onchange="annCategoryChanged()" class="peer sr-only" />
            <div class="px-2 py-1 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-nadi peer-checked:border-nadi peer-checked:bg-blue-50 text-center transition-all flex items-center justify-center">
              <span class="text-[9px] font-bold uppercase">SSO</span>
            </div>
          </label>
        </div>
        <div id="ssoMainContainer" class="hidden">
          <div aria-label="SSO Main Category Selection" class="text-[11px] font-bold text-slate-500 uppercase block mb-1.5">SSO Category</div>
          <div class="grid grid-cols-2 gap-1.5">
            <label class="relative cursor-pointer group">
              <input type="radio" id="ssoCategoryUsahawan" name="ssoCategory" value="Usahawan" onchange="annSSOMainChanged()" class="peer sr-only" />
              <div class="px-2 py-1.5 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-yellow-700 peer-checked:border-yellow-400 peer-checked:bg-yellow-50 text-center transition-all flex items-center justify-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-yellow-400"></span>
                <span class="text-[10px] font-bold uppercase">Usahawan</span>
              </div>
            </label>
            <label class="relative cursor-pointer group">
              <input type="radio" id="ssoCategoryKesejahteraan" name="ssoCategory" value="Kesejahteraan Kendiri" onchange="annSSOMainChanged()" class="peer sr-only" />
              <div class="px-2 py-1.5 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-emerald-700 peer-checked:border-emerald-400 peer-checked:bg-emerald-50 text-center transition-all flex items-center justify-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                <span class="text-[10px] font-bold uppercase">Kesejahteraan</span>
              </div>
            </label>
            <label class="relative cursor-pointer group">
              <input type="radio" id="ssoCategoryKesedaran" name="ssoCategory" value="Kesedaran" onchange="annSSOMainChanged()" class="peer sr-only" />
              <div class="px-2 py-1.5 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-violet-700 peer-checked:border-violet-400 peer-checked:bg-violet-50 text-center transition-all flex items-center justify-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-violet-500"></span>
                <span class="text-[10px] font-bold uppercase">Kesedaran</span>
              </div>
            </label>
            <label class="relative cursor-pointer group">
              <input type="radio" id="ssoCategoryKerajaan" name="ssoCategory" value="Inisiatif Kerajaan" onchange="annSSOMainChanged()" class="peer sr-only" />
              <div class="px-2 py-1.5 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-red-700 peer-checked:border-red-400 peer-checked:bg-red-50 text-center transition-all flex items-center justify-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span>
                <span class="text-[10px] font-bold uppercase">Kerajaan</span>
              </div>
            </label>
            <label class="relative cursor-pointer group col-span-2">
              <input type="radio" id="ssoCategoryPembelajaran" name="ssoCategory" value="Pembelajaran Sepanjang Hayat" onchange="annSSOMainChanged()" class="peer sr-only" />
              <div class="px-2 py-1.5 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-blue-700 peer-checked:border-blue-400 peer-checked:bg-blue-50 text-center transition-all flex items-center justify-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                <span class="text-[10px] font-bold uppercase">Pembelajaran Sepanjang Hayat</span>
              </div>
            </label>
          </div>
        </div>
        <div id="ssoSubContainer" class="hidden">
          <div aria-label="SSO Subcategory Selection" class="text-[11px] font-bold text-slate-500 uppercase block mb-1.5">SSO Subcategory</div>
          <div id="ssoSubRadioContainer" class="grid grid-cols-2 gap-1.5"></div>
        </div>
        <div>
          <div class="text-[11px] font-bold text-slate-500 uppercase block mb-1.5">Content</div>
        </div>
        <div class="border border-slate-200 rounded-lg overflow-hidden">
          <div class="flex gap-1 p-2 bg-slate-100 border-b border-slate-200">
            <button type="button" onclick="annExecFormat('bold')" class="w-8 h-8 rounded hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-colors" title="Bold"><i class="fa-solid fa-bold text-xs"></i></button>
            <button type="button" onclick="annExecFormat('italic')" class="w-8 h-8 rounded hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-colors" title="Italic"><i class="fa-solid fa-italic text-xs"></i></button>
            <button type="button" onclick="annExecFormat('underline')" class="w-8 h-8 rounded hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-colors" title="Underline"><i class="fa-solid fa-underline text-xs"></i></button>
            <label for="annFontSize" class="sr-only">Font Size</label>
            <select id="annFontSize" name="annFontSize" onchange="annChangeFontSize(this.value)" class="px-2 h-8 bg-white border border-slate-200 rounded text-xs font-semibold outline-none cursor-pointer text-slate-600">
              <option value="" disabled selected>Size</option>
              <option value="11">11</option>
              <option value="12">12</option>
            </select>
            <button type="button" onclick="annInsertLink()" class="w-8 h-8 rounded hover:bg-slate-200 text-blue-600 flex items-center justify-center transition-colors" title="Link"><i class="fa-solid fa-link text-xs"></i></button>
          </div>
          <div id="announcementEditor" contenteditable="true" class="w-full min-h-[120px] p-3 bg-white text-sm text-slate-700 outline-none" placeholder="Details..."></div>
        </div>
        <div id="announcementImagesSection">
          <div class="text-[11px] font-bold text-slate-500 uppercase block mb-1.5">Images (Optional)</div>
          <div
            id="announcementImageDropzone"
            class="border-2 border-dashed border-slate-200 rounded-lg p-3 bg-white text-center text-xs text-slate-500"
            ondragover="annHandleImageDragOver(event)"
            ondragenter="annHandleImageDragOver(event)"
            ondragleave="annHandleImageDragLeave(event)"
            ondrop="annHandleImageDrop(event)"
          >
            <p class="font-semibold text-slate-600">Drag & drop images here</p>
            <p class="text-[10px] text-slate-400 mt-1">or</p>
            <button id="announcementImagesButton" type="button" onclick="annTriggerImagePicker()" class="mt-2 inline-flex items-center gap-1 px-3 py-1.5 bg-slate-900 text-white text-xs font-bold rounded-lg hover:bg-slate-800 transition-colors">
              <i class="fa-regular fa-image"></i> Upload Images
            </button>
            <input
              type="file"
              id="announcementImages"
              name="announcementImages"
              accept="image/*"
              multiple
              onchange="annHandleImageSelection(this)"
              class="hidden"
            />
            <p class="text-[10px] text-slate-400 mt-2">Max 5 MB per image.</p>
            <p id="announcementImagesDisabledNote" class="hidden text-[10px] text-red-500 mt-2">Images are disabled until the `images` column exists in Supabase.</p>
          </div>
          <div id="announcementImagePreview" class="grid grid-cols-3 gap-2 mt-2"></div>
          <p class="text-[10px] text-slate-400 mt-1">Click a thumbnail to preview. Use the X to remove.</p>
        </div>
          <label for="announcementDueDate" class="sr-only">Due Date</label>
          <input type="date" id="announcementDueDate" name="announcementDueDate" autocomplete="off" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-nadi" />
        <div class="flex gap-2">
          <button onclick="annSaveAnnouncement()" class="flex-1 py-2.5 bg-nadi hover:bg-[#1b1d8a] text-white text-sm font-bold rounded-lg shadow transition-colors">Save</button>
          <button onclick="annHideAddForm()" class="px-4 py-2.5 bg-slate-200 hover:bg-slate-300 text-slate-600 text-sm font-bold rounded-lg transition-colors">Cancel</button>
        </div>
      </div>
    </div>

    <div id="deleteModal" class="fixed inset-0 z-50 hidden">
      <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="annCloseDeleteModal()"></div>
      <div class="fixed inset-0 z-50 flex items-start justify-center px-4 pt-8 pb-6">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm">
          <div class="px-4 py-3 border-b border-slate-200 flex justify-between items-center bg-red-50 rounded-t-xl">
            <h3 class="text-base font-bold text-red-700">Delete Announcement</h3>
            <button onclick="annCloseDeleteModal()" class="w-7 h-7 rounded-full bg-red-100 hover:bg-red-200 flex items-center justify-center text-red-600"><i class="fa-solid fa-xmark text-xs"></i></button>
          </div>
          <div class="p-4">
            <p class="text-sm text-slate-600">Are you sure you want to delete this announcement? This action cannot be undone.</p>
          </div>
          <div class="px-4 py-3 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-end gap-2">
            <button onclick="annCloseDeleteModal()" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-800">Cancel</button>
            <button id="deleteConfirmBtn" onclick="annConfirmDelete()" class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-bold rounded-lg shadow">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <div id="urlInputModal" class="fixed inset-0 z-50 hidden">
      <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="annCloseUrlInputModal()"></div>
      <div class="fixed inset-0 z-50 flex items-start justify-center px-4 pt-20 pb-6">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
          <div class="px-4 py-3 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
            <h3 class="text-base font-bold text-slate-900">Insert Link</h3>
            <button onclick="annCloseUrlInputModal()" class="w-7 h-7 rounded-full bg-slate-200 hover:bg-slate-300 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark text-xs"></i></button>
          </div>
          <div class="p-4 space-y-3">
            <div>
              <label for="annLinkTextField" class="text-xs font-bold text-slate-500 uppercase block mb-1">Display Text</label>
              <input type="text" id="annLinkTextField" name="annLinkTextField" autocomplete="off" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm outline-none focus:border-blue-400" placeholder="Click here" />
            </div>
            <div>
              <label for="annUrlInputField" class="text-xs font-bold text-slate-500 uppercase block mb-1">URL <span class="text-red-500">*</span></label>
              <input type="url" id="annUrlInputField" name="annUrlInputField" autocomplete="off" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm outline-none focus:border-blue-400" placeholder="https://example.com" onkeydown="if(event.key==='Enter') annConfirmInsertLink()" />
            </div>
          </div>
          <div class="px-4 py-3 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-end gap-2">
            <button onclick="annCloseUrlInputModal()" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-800">Cancel</button>
            <button onclick="annConfirmInsertLink()" class="px-5 py-2 bg-slate-900 hover:bg-slate-800 text-white text-sm font-bold rounded-lg shadow">Insert</button>
          </div>
        </div>
      </div>
    </div>
    
    <div id="announcementImageModal" class="fixed inset-0 z-50 hidden" onclick="handleAnnouncementImageOverlayClick(event)">
      <div id="announcementImageBackdrop" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
      <div class="fixed inset-0 z-50 flex items-center justify-center px-4">
        <div id="announcementImagePanel" class="bg-white rounded-xl shadow-xl w-full max-w-2xl overflow-hidden">
          <div id="announcementImageHeader" class="px-4 py-3 border-b border-slate-200 flex justify-between items-center bg-slate-50">
            <h3 class="text-sm font-bold text-slate-900">Image Preview</h3>
            <button onclick="closeAnnouncementImageViewer()" class="w-7 h-7 rounded-full bg-slate-200 hover:bg-slate-300 flex items-center justify-center text-slate-500">
              <i class="fa-solid fa-xmark text-xs"></i>
            </button>
          </div>
          <div id="announcementImageStage" class="p-4 bg-slate-50 flex items-center justify-center">
            <div id="announcementImageFrame" class="relative inline-flex max-w-full">
              <img id="announcementImagePreviewLarge" src="" alt="Announcement image" class="max-h-[80vh] max-w-full w-auto rounded border border-slate-200 bg-white" />
              <button id="announcementImagePrev" onclick="showPrevAnnouncementImage()" class="absolute left-2 top-1/2 -translate-y-1/2 w-9 h-9 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
                <i class="fa-solid fa-chevron-left"></i>
              </button>
              <button id="announcementImageNext" onclick="showNextAnnouncementImage()" class="absolute right-2 top-1/2 -translate-y-1/2 w-9 h-9 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
                <i class="fa-solid fa-chevron-right"></i>
              </button>
              <button id="announcementImageFullscreen" onclick="toggleAnnouncementImageFullscreen()" class="absolute right-2 bottom-2 w-9 h-9 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 transition-colors" aria-label="Toggle full view">
                <i id="announcementImageFullscreenIcon" class="fa-solid fa-expand"></i>
              </button>
            </div>
          </div>
          <div id="announcementImageFooter" class="px-4 py-3 border-t border-slate-100 bg-white flex flex-wrap items-center justify-between gap-2">
            <span id="announcementImageCounter" class="text-[11px] text-slate-500 font-semibold"></span>
            <div class="flex items-center gap-2">
              <button onclick="copyAnnouncementImage()" class="px-4 py-2 text-xs font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                Copy Image
              </button>
              <button onclick="downloadAnnouncementImage()" class="px-4 py-2 text-xs font-bold text-white bg-slate-900 hover:bg-slate-800 rounded-lg transition-colors">
                Download
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="js/config.js"></script>
    <script>
      let announcements = [];
      let siteSettings = {
        title: "NADI SCSB",
        subtitle: "PULAU PINANG",
        sections: [],
        managerOffdays: [],
        assistantManagerOffdays: [],
        managerReplacements: [],
        assistantManagerReplacements: [],
        publicHolidays: {},
        schoolHolidays: {},
        calendarFilters: { showCategories: true, showHolidays: true, showSchoolHolidays: true, showOffdays: true },
        announcements: [],
      };
      let currentAnnouncementFilter = "all";
      let currentSSOSubFilter = "";
      let currentSSOSubSubFilter = "";
      let announcementSearchQuery = "";
      let announcementSearchTimeout = null;
      let annEditingId = null;
      const ANNOUNCEMENT_IMAGE_BUCKET = "announcement-images";
      let announcementImagesEnabled = true;
      let annExistingImages = [];
      let annNewImageFiles = [];
      let annRemovedImages = [];
      let annNewImagePreviewUrls = [];
      let currentAnnouncementImageUrl = "";
      let currentAnnouncementImageName = "";
      let currentAnnouncementImageList = [];
      let currentAnnouncementImageIndex = 0;
      let announcementImageMap = {};
      let announcementImageMaximized = false;
      const ANNOUNCEMENT_IMAGE_DISABLED_MSG = "Images are disabled until the `images` column exists in Supabase.";

      function isMissingColumnError(error) {
        if (!error) return false;
        if (error.code === "42703") return true;
        const message = typeof error.message === "string" ? error.message : "";
        return /column .* does not exist/i.test(message);
      }

      function escapeAttribute(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function normalizeAnnouncementImages(images) {
        if (!Array.isArray(images)) return [];
        return images
          .map((img) => {
            if (!img) return null;
            if (typeof img === "string") return { url: img, path: null, name: "" };
            const url = img.url || img.publicUrl || img.href || "";
            return url ? { url: url, path: img.path || null, name: img.name || "" } : null;
          })
          .filter(Boolean);
      }

      function resetAnnouncementImageState() {
        annExistingImages = [];
        annNewImageFiles = [];
        annRemovedImages = [];
        annNewImagePreviewUrls.forEach((url) => URL.revokeObjectURL(url));
        annNewImagePreviewUrls = [];
        const input = document.getElementById("announcementImages");
        if (input) input.value = "";
        const preview = document.getElementById("announcementImagePreview");
        if (preview) preview.innerHTML = "";
      }

      function setAnnouncementImagesEnabled(isEnabled) {
        announcementImagesEnabled = isEnabled;
        const input = document.getElementById("announcementImages");
        const button = document.getElementById("announcementImagesButton");
        const note = document.getElementById("announcementImagesDisabledNote");
        const zone = document.getElementById("announcementImageDropzone");

        if (input) input.disabled = !isEnabled;
        if (button) {
          button.disabled = !isEnabled;
          button.classList.toggle("opacity-50", !isEnabled);
          button.classList.toggle("cursor-not-allowed", !isEnabled);
        }
        if (zone) {
          zone.classList.toggle("opacity-60", !isEnabled);
          zone.classList.toggle("cursor-not-allowed", !isEnabled);
        }
        if (note) note.classList.toggle("hidden", isEnabled);
      }

      function renderAnnouncementImagePreviews() {
        const container = document.getElementById("announcementImagePreview");
        if (!container) return;

        annNewImagePreviewUrls.forEach((url) => URL.revokeObjectURL(url));
        annNewImagePreviewUrls = [];

        const previewItems = [];

        annExistingImages.forEach((img, index) => {
          const safeUrl = escapeAttribute(img.url);
          previewItems.push(`
            <div class="relative group">
              <button type="button" onclick="annOpenPreviewImage('existing', ${index})" class="block w-full">
                <img src="${safeUrl}" alt="Announcement image" class="w-full h-24 object-cover rounded border border-slate-200" />
              </button>
              <button type="button" onclick="annRemoveExistingImage(${index})" class="absolute top-1 right-1 w-5 h-5 rounded-full bg-black/60 text-white text-[10px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          `);
        });

        annNewImageFiles.forEach((file, index) => {
          const previewUrl = URL.createObjectURL(file);
          annNewImagePreviewUrls.push(previewUrl);
          previewItems.push(`
            <div class="relative group">
              <button type="button" onclick="annOpenPreviewImage('new', ${index})" class="block w-full">
                <img src="${escapeAttribute(previewUrl)}" alt="New image" class="w-full h-24 object-cover rounded border border-slate-200" />
              </button>
              <button type="button" onclick="annRemoveNewImage(${index})" class="absolute top-1 right-1 w-5 h-5 rounded-full bg-black/60 text-white text-[10px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          `);
        });

        container.innerHTML = previewItems.join("");
      }

      function annTriggerImagePicker() {
        if (!announcementImagesEnabled) {
          alert(ANNOUNCEMENT_IMAGE_DISABLED_MSG);
          return;
        }
        const input = document.getElementById("announcementImages");
        if (input) input.click();
      }

      function annValidateImageFiles(files) {
        const maxSize = 5 * 1024 * 1024;
        const accepted = [];
        const rejected = [];

        files.forEach((file) => {
          if (!file.type.startsWith("image/")) {
            rejected.push(`${file.name} (not an image)`);
            return;
          }
          if (file.size > maxSize) {
            rejected.push(`${file.name} (over 5 MB)`);
            return;
          }
          accepted.push(file);
        });

        if (rejected.length > 0) {
          alert(`Some files were skipped:\n- ${rejected.join("\n- ")}`);
        }

        return accepted;
      }

      function annHandleImageSelection(input) {
        if (!announcementImagesEnabled) {
          alert(ANNOUNCEMENT_IMAGE_DISABLED_MSG);
          if (input) input.value = "";
          return;
        }
        const files = Array.from(input.files || []);
        if (!files.length) return;
        const imageFiles = annValidateImageFiles(files);
        if (!imageFiles.length) return;
        annNewImageFiles = annNewImageFiles.concat(imageFiles);
        input.value = "";
        renderAnnouncementImagePreviews();
      }

      function annHandleImageDragOver(event) {
        if (!announcementImagesEnabled) return;
        event.preventDefault();
        annSetDropActive(true);
      }

      function annHandleImageDragLeave(event) {
        if (!announcementImagesEnabled) return;
        event.preventDefault();
        annSetDropActive(false);
      }

      function annHandleImageDrop(event) {
        if (!announcementImagesEnabled) {
          event.preventDefault();
          alert(ANNOUNCEMENT_IMAGE_DISABLED_MSG);
          return;
        }
        event.preventDefault();
        annSetDropActive(false);
        const files = Array.from(event.dataTransfer?.files || []);
        if (!files.length) return;
        const imageFiles = annValidateImageFiles(files);
        if (!imageFiles.length) return;
        annNewImageFiles = annNewImageFiles.concat(imageFiles);
        renderAnnouncementImagePreviews();
      }

      function annSetDropActive(isActive) {
        const zone = document.getElementById("announcementImageDropzone");
        if (!zone) return;
        if (isActive) {
          zone.classList.add("ring-2", "ring-blue-300", "bg-blue-50/60");
        } else {
          zone.classList.remove("ring-2", "ring-blue-300", "bg-blue-50/60");
        }
      }

      function annRemoveExistingImage(index) {
        const removed = annExistingImages.splice(index, 1)[0];
        if (removed) annRemovedImages.push(removed);
        renderAnnouncementImagePreviews();
      }

      function annRemoveNewImage(index) {
        annNewImageFiles.splice(index, 1);
        renderAnnouncementImagePreviews();
      }

      function annOpenPreviewImage(type, index) {
        const list = [];
        annExistingImages.forEach((img) => list.push({ url: img.url, name: img.name || "announcement-image" }));
        annNewImageFiles.forEach((file, fileIndex) => {
          const url = annNewImagePreviewUrls[fileIndex];
          if (url) list.push({ url, name: file.name || "new-image" });
        });
        let offset = 0;
        if (type === "existing") {
          offset = index;
        } else {
          offset = annExistingImages.length + index;
        }
        if (list.length > 0) openAnnouncementImageViewerWithList(list, offset);
      }

      function openAnnouncementImageViewer(url, name = "") {
        openAnnouncementImageViewerWithList([{ url, name: name || "announcement-image" }], 0);
      }

      function openAnnouncementImageViewerWithList(images, index) {
        const modal = document.getElementById("announcementImageModal");
        if (!modal || !Array.isArray(images) || images.length === 0) return;
        currentAnnouncementImageList = images;
        currentAnnouncementImageIndex = Math.min(Math.max(index, 0), images.length - 1);
        updateAnnouncementImageViewer();
        modal.classList.remove("hidden");
      }

      function updateAnnouncementImageViewer() {
        const img = document.getElementById("announcementImagePreviewLarge");
        const counter = document.getElementById("announcementImageCounter");
        const prevBtn = document.getElementById("announcementImagePrev");
        const nextBtn = document.getElementById("announcementImageNext");
        if (!img) return;
        const current = currentAnnouncementImageList[currentAnnouncementImageIndex];
        if (!current) return;
        currentAnnouncementImageUrl = current.url;
        currentAnnouncementImageName = current.name || "announcement-image";
        img.src = currentAnnouncementImageUrl;
        img.alt = currentAnnouncementImageName;
        if (counter) counter.textContent = `${currentAnnouncementImageIndex + 1} / ${currentAnnouncementImageList.length}`;
        const isPrevDisabled = currentAnnouncementImageIndex <= 0;
        const isNextDisabled = currentAnnouncementImageIndex >= currentAnnouncementImageList.length - 1;
        if (prevBtn) {
          prevBtn.disabled = isPrevDisabled;
          prevBtn.classList.toggle("opacity-40", isPrevDisabled);
          prevBtn.classList.toggle("hidden", isPrevDisabled);
        }
        if (nextBtn) {
          nextBtn.disabled = isNextDisabled;
          nextBtn.classList.toggle("opacity-40", isNextDisabled);
          nextBtn.classList.toggle("hidden", isNextDisabled);
        }
      }

      function showPrevAnnouncementImage() {
        if (currentAnnouncementImageIndex <= 0) return;
        currentAnnouncementImageIndex -= 1;
        updateAnnouncementImageViewer();
      }

      function showNextAnnouncementImage() {
        if (currentAnnouncementImageIndex >= currentAnnouncementImageList.length - 1) return;
        currentAnnouncementImageIndex += 1;
        updateAnnouncementImageViewer();
      }

      function closeAnnouncementImageViewer() {
        const modal = document.getElementById("announcementImageModal");
        const img = document.getElementById("announcementImagePreviewLarge");
        if (img) img.src = "";
        if (modal) modal.classList.add("hidden");
        currentAnnouncementImageUrl = "";
        currentAnnouncementImageName = "";
        currentAnnouncementImageList = [];
        currentAnnouncementImageIndex = 0;
        exitAnnouncementImageFullscreen();
      }

      function handleAnnouncementImageOverlayClick(event) {
        const panel = document.getElementById("announcementImagePanel");
        const frame = document.getElementById("announcementImageFrame");
        const target = event?.target;
        if (!panel || !target) return;

        if (!announcementImageMaximized) {
          if (!panel.contains(target)) {
            closeAnnouncementImageViewer();
          }
          return;
        }

        if (frame && !frame.contains(target)) {
          exitAnnouncementImageFullscreen();
        }
      }

      async function copyAnnouncementImage() {
        if (!currentAnnouncementImageUrl) return;
        try {
          if (navigator.clipboard && window.ClipboardItem) {
            const response = await fetch(currentAnnouncementImageUrl);
            const blob = await response.blob();
            await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
            alert("Image copied to clipboard.");
            return;
          }
        } catch (error) {}

        try {
          await navigator.clipboard.writeText(currentAnnouncementImageUrl);
          alert("Image link copied to clipboard.");
        } catch (error) {
          alert("Unable to copy image. Please use Download.");
        }
      }

      function downloadAnnouncementImage() {
        if (!currentAnnouncementImageUrl) return;
        const link = document.createElement("a");
        link.href = currentAnnouncementImageUrl;
        link.download = currentAnnouncementImageName || "announcement-image";
        document.body.appendChild(link);
        link.click();
        link.remove();
      }

      function toggleAnnouncementImageFullscreen() {
        const modal = document.getElementById("announcementImageModal");
        const icon = document.getElementById("announcementImageFullscreenIcon");
        if (!modal) return;
        announcementImageMaximized = !announcementImageMaximized;
        modal.classList.toggle("image-modal-full", announcementImageMaximized);
        if (icon) {
          icon.classList.toggle("fa-expand", !announcementImageMaximized);
          icon.classList.toggle("fa-compress", announcementImageMaximized);
        }
      }

      function exitAnnouncementImageFullscreen() {
        const modal = document.getElementById("announcementImageModal");
        const icon = document.getElementById("announcementImageFullscreenIcon");
        announcementImageMaximized = false;
        if (modal) modal.classList.remove("image-modal-full");
        if (icon) {
          icon.classList.remove("fa-compress");
          icon.classList.add("fa-expand");
        }
      }

      function annOpenCardImage(announcementId, index) {
        const images = announcementImageMap[announcementId] || [];
        if (!images.length) return;
        openAnnouncementImageViewerWithList(images, index);
      }

      async function uploadAnnouncementImages(announcementId, files) {
        const uploaded = [];
        for (const file of files) {
          const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
          const uniquePart = `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
          const path = `announcements/${announcementId}/${uniquePart}-${safeName}`;
          const { error } = await supabaseClient
            .storage
            .from(ANNOUNCEMENT_IMAGE_BUCKET)
            .upload(path, file, { contentType: file.type, upsert: false });
          if (error) throw error;
          const { data } = supabaseClient.storage.from(ANNOUNCEMENT_IMAGE_BUCKET).getPublicUrl(path);
          if (data?.publicUrl) {
            uploaded.push({ url: data.publicUrl, path: path, name: file.name });
          }
        }
        return uploaded;
      }

      async function deleteAnnouncementImages(images) {
        const paths = images.map((img) => img.path).filter(Boolean);
        if (!paths.length) return;
        try {
          await supabaseClient.storage.from(ANNOUNCEMENT_IMAGE_BUCKET).remove(paths);
        } catch (error) {}
      }

      function annShowAddForm() {
        document.getElementById("addForm").classList.remove("hidden");
        document.getElementById("announcementTitle").focus();
        document.getElementById("announcementEditor").style.fontSize = "12px";
        resetAnnouncementImageState();
        
        // If editing, don't change the form values - annEditAnnouncement handles that
        if (annEditingId) {
          return;
        }
        
        const filter = currentAnnouncementFilter;
        if (filter && filter !== "all") {
          const catRadio = document.querySelector(`input[name="annCategory"][value="${filter}"]`);
          if (catRadio) catRadio.checked = true;
          annCategoryChanged();
        } else {
          document.querySelectorAll('input[name="annCategory"]').forEach(r => r.checked = false);
          document.getElementById("ssoMainContainer").classList.add("hidden");
          document.getElementById("ssoSubContainer").classList.add("hidden");
          document.getElementById("ssoSubRadioContainer").innerHTML = "";
        }
      }

      function annHideAddForm() {
        document.getElementById("addForm").classList.add("hidden");
        document.getElementById("announcementTitle").value = "";
        document.getElementById("announcementEditor").innerHTML = "";
        document.getElementById("announcementEditor").style.fontSize = "12px";
        resetAnnouncementImageState();
        const allRadio = document.querySelector('input[name="annCategory"][value="Urgent"]');
        if (allRadio) allRadio.checked = true;
        document.querySelectorAll('input[name="ssoCategory"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[name="ssoSubCategory"]').forEach(r => r.checked = false);
        document.getElementById("announcementDueDate").value = "";
        document.getElementById("ssoMainContainer").classList.add("hidden");
        document.getElementById("ssoSubContainer").classList.add("hidden");
        annEditingId = null;
      }

      function annCategoryChanged() {
        const category = document.querySelector('input[name="annCategory"]:checked')?.value || "all";
        const ssoMainContainer = document.getElementById("ssoMainContainer");
        const ssoSubContainer = document.getElementById("ssoSubContainer");
        if (category === "SSO") {
          ssoMainContainer.classList.remove("hidden");
          ssoSubContainer.classList.add("hidden");
          document.querySelectorAll('input[name="ssoCategory"]').forEach(r => r.checked = false);
          document.querySelectorAll('input[name="ssoSubCategory"]').forEach(r => r.checked = false);
        } else {
          ssoMainContainer.classList.add("hidden");
          ssoSubContainer.classList.add("hidden");
          document.querySelectorAll('input[name="ssoCategory"]').forEach(r => r.checked = false);
          document.querySelectorAll('input[name="ssoSubCategory"]').forEach(r => r.checked = false);
        }
      }

      function annSSOMainChanged() {
        const mainCategory = document.querySelector('input[name="ssoCategory"]:checked')?.value;
        const ssoSubContainer = document.getElementById("ssoSubContainer");
        const ssoSubRadioContainer = document.getElementById("ssoSubRadioContainer");
        const subMap = {
          "Usahawan": ["eKelas Keusahawanan (Maxis)", "Preneur/EmpowHER", "Kidventure"],
          "Kesejahteraan Kendiri": ["Care"],
          "Kesedaran": ["Safe & Shield"],
          "Inisiatif Kerajaan": [],
          "Pembelajaran Sepanjang Hayat": ["eKelas Maxis", "DiLea", "TinyTechies", "ESPORT", "Cybersecurity", "MAHIR"],
        };
        if (mainCategory && subMap[mainCategory] && subMap[mainCategory].length > 0) {
          ssoSubContainer.classList.remove("hidden");
          ssoSubRadioContainer.innerHTML = subMap[mainCategory].map((sub) => `
            <label class="relative cursor-pointer group">
              <input type="radio" name="ssoSubCategory" value="${sub}" class="peer sr-only" />
              <div class="px-2 py-1.5 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-nadi peer-checked:border-nadi peer-checked:bg-blue-50 text-center transition-all flex items-center justify-center">
                <span class="text-[9px] font-bold uppercase">${sub}</span>
              </div>
            </label>
          `).join("");
        } else {
          ssoSubContainer.classList.add("hidden");
        }
      }

      function annExecFormat(command) {
        document.execCommand(command, false, null);
        document.getElementById("announcementEditor").focus();
      }

      function annChangeFontSize(size) {
        if (size) {
          const selectedSize = size + "px";
          document.execCommand("fontSize", false, "7");
          setTimeout(() => {
            const editor = document.getElementById("announcementEditor");
            const fontTags = editor.querySelectorAll('font[size="7"]');
            fontTags.forEach((fontTag) => {
              fontTag.style.fontSize = selectedSize;
              fontTag.removeAttribute("size");
            });
          }, 10);
        }
        document.getElementById("announcementEditor").focus();
      }

      function annClearFormatting() {
        document.execCommand("removeFormat", false, null);
        document.getElementById("announcementEditor").focus();
      }

      function annInsertLink() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
        document.getElementById("annLinkTextField").value = selectedText;
        document.getElementById("annUrlInputField").value = "https://";
        document.getElementById("urlInputModal").classList.remove("hidden");
        setTimeout(() => document.getElementById("annUrlInputField").focus(), 100);
      }

      function annConfirmInsertLink() {
        const url = document.getElementById("annUrlInputField").value.trim();
        if (!url) { alert("Please enter a URL."); return; }
        const text = document.getElementById("annLinkTextField").value.trim();
        const linkText = text || url;
        document.execCommand("insertHTML", false, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">${linkText}</a>`);
        annCloseUrlInputModal();
      }

      function annCloseUrlInputModal() {
        document.getElementById("urlInputModal").classList.add("hidden");
      }

      let pendingDeleteId = null;

      function annShowDeleteModal(id) {
        pendingDeleteId = id;
        document.getElementById("deleteModal").classList.remove("hidden");
      }

      function annCloseDeleteModal() {
        document.getElementById("deleteModal").classList.add("hidden");
        pendingDeleteId = null;
      }

      function annConfirmDelete() {
        if (pendingDeleteId) {
          annDeleteAnnouncement(pendingDeleteId);
        }
        annCloseDeleteModal();
      }

      function formatDateStr(dateInput) {
        let date;
        if (!dateInput) {
          date = new Date();
        } else {
          try {
            if (typeof dateInput === "string" && dateInput.includes("T")) {
              date = new Date(dateInput);
            } else if (typeof dateInput === "string") {
              date = new Date(dateInput + "T00:00:00");
            } else {
              date = new Date(dateInput);
            }
            if (isNaN(date.getTime())) {
              date = new Date();
            }
          } catch (e) {
            date = new Date();
          }
        }
        const dateStr = date.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
        const timeStr = date.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", hour12: true });
        return { date: dateStr, time: timeStr };
      }

      function formatDueDate(dateStr, timeStr) {
        if (!dateStr) return "";
        let result = formatDateStr(dateStr).date;
        if (timeStr) {
          const [h, m] = timeStr.split(":");
          const hour = parseInt(h);
          const ampm = hour >= 12 ? "PM" : "AM";
          const hour12 = hour % 12 || 12;
          result += `, ${hour12}:${m} ${ampm}`;
        }
        return result;
      }

      const announcementStorage = (() => {
        const memory = new Map();
        const isIframe = (() => {
          try {
            return window.top !== window.self;
          } catch (error) {
            return true;
          }
        })();
        return {
          getItem(key) {
            if (isIframe) return memory.get(key) ?? null;
            try {
              return localStorage.getItem(key);
            } catch (error) {
              return memory.get(key) ?? null;
            }
          },
          setItem(key, value) {
            if (isIframe) {
              memory.set(key, String(value));
              return;
            }
            try {
              localStorage.setItem(key, String(value));
            } catch (error) {
              memory.set(key, String(value));
            }
          },
          removeItem(key) {
            if (isIframe) {
              memory.delete(key);
              return;
            }
            try {
              localStorage.removeItem(key);
            } catch (error) {
              memory.delete(key);
            }
          }
        };
      })();

      function sanitizeHTML(html) {
        if (typeof DOMPurify !== "undefined") return DOMPurify.sanitize(html, {
          ADD_TAGS: ["iframe"],
          ADD_ATTR: ["allow", "allowfullscreen", "frameborder", "scrolling", "target"],
          FORBID_TAGS: ["script", "style", "form"],
        });
        const temp = document.createElement("div");
        temp.textContent = html;
        return temp.innerHTML;
      }

      function sanitizeHTMLWithLinks(html) {
        let sanitized = sanitizeHTML(html);
        const temp = document.createElement("div");
        temp.innerHTML = sanitized;
        temp.querySelectorAll("a").forEach((a) => {
          a.setAttribute("target", "_blank");
          a.setAttribute("rel", "noopener noreferrer");
        });
        return temp.innerHTML;
      }

      function convertBoldSyntax(text) {
        if (!text) return text;
        // First, temporarily replace URLs with placeholders to preserve them
        // Use placeholder without underscores/asterisks to avoid conversion
        const urlPlaceholder = '<<URL>>';
        const urls = [];
        text = text.replace(/(https?:\/\/[^\s<"]+)/gi, (match) => {
          const idx = urls.length;
          urls.push(match);
          return `${urlPlaceholder}${idx}${urlPlaceholder}`;
        });
        // Now apply the bold/italic conversions
        text = text.replace(/_\*([^*]+)\*_/g, '<strong><em>$1</em></strong>');
        text = text.replace(/\*([^*]+)\*/g, '<strong>$1</strong>');
        text = text.replace(/_([^_]+)_/g, '<em>$1</em>');
        // Restore URLs
        urls.forEach((url, idx) => {
          text = text.replace(`${urlPlaceholder}${idx}${urlPlaceholder}`, url);
        });
        return text;
      }

      // Debounce function for search
      function debounceAnnouncementSearch(func, wait) {
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(announcementSearchTimeout);
            func(...args);
          };
          clearTimeout(announcementSearchTimeout);
          announcementSearchTimeout = setTimeout(later, wait);
        };
      }

      // Handle search input with debounce
      const debouncedAnnouncementSearch = debounceAnnouncementSearch((query) => {
        announcementSearchQuery = query.toLowerCase().trim();
        renderAnnouncementList();
      }, 300);

      function annHandleSearch(value) {
        const clearBtn = document.getElementById("announcementSearchClear");
        if (clearBtn) {
          clearBtn.classList.toggle("hidden", !value);
        }
        debouncedAnnouncementSearch(value);
      }

      function annClearSearch() {
        const searchInput = document.getElementById("announcementSearch");
        if (searchInput) {
          searchInput.value = "";
        }
        const clearBtn = document.getElementById("announcementSearchClear");
        if (clearBtn) {
          clearBtn.classList.add("hidden");
        }
        announcementSearchQuery = "";
        renderAnnouncementList();
      }

      // Highlight search term in text
      function highlightSearchText(text) {
        if (!text || !announcementSearchQuery) return text;
        const regex = new RegExp(`(${announcementSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<mark class="bg-yellow-200 text-slate-800 px-0.5 rounded">$1</mark>');
      }

      function setAnnouncementFilter(filter) {
        currentAnnouncementFilter = filter;
        currentSSOSubFilter = "";
        currentSSOSubSubFilter = "";
        document.getElementById("ssoSubFilter").classList.add("hidden");
        document.getElementById("ssoSubSubFilter").classList.add("hidden");
        
        document.querySelectorAll('[data-ann-filter]').forEach((btn) => {
          const btnFilter = btn.dataset.annFilter;
          if (btnFilter === filter) {
            btn.className = `px-4 py-2 text-xs font-bold rounded-lg transition-colors ${filter === "Urgent" ? "bg-red-500 text-white" : "bg-nadi text-white"}`;
          } else {
            btn.className = "px-4 py-2 text-xs font-bold rounded-lg transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200";
          }
        });
        
        // Reset SSO subfilter radio buttons
        document.querySelectorAll('input[name="ssoMainFilter"]').forEach((radio) => {
          radio.checked = false;
        });
        
        // Show SSO subfilter if SSO is selected
        if (filter === "SSO") {
          document.getElementById("ssoSubFilter").classList.remove("hidden");
          renderAnnouncementList();
        } else {
          renderAnnouncementList();
        }
      }

      function setSSOSubFilter(subFilter) {
        currentSSOSubFilter = subFilter;
        
        document.querySelectorAll('input[name="ssoSubFilter"]').forEach((radio) => {
          if (radio.value === subFilter) {
            radio.checked = true;
          }
        });
        
        const ssoSubSubFilter = document.getElementById("ssoSubSubFilter");
        const ssoSubSubFilterContainer = document.getElementById("ssoSubSubFilterContainer");
        const subMap = {
          "Usahawan": ["eKelas Keusahawanan (Maxis)", "Preneur/EmpowHER", "Kidventure"],
          "Kesejahteraan Kendiri": ["Care"],
          "Kesedaran": ["Safe & Shield"],
          "Inisiatif Kerajaan": [],
          "Pembelajaran Sepanjang Hayat": ["eKelas Maxis", "DiLea", "TinyTechies", "ESPORT", "Cybersecurity", "MAHIR"],
        };
        
        if (subFilter && subMap[subFilter] && subMap[subFilter].length > 0) {
          ssoSubSubFilter.classList.remove("hidden");
          ssoSubSubFilterContainer.innerHTML = subMap[subFilter].map((sub) => `
            <label class="relative cursor-pointer group">
              <input type="radio" name="ssoSubSubFilter" value="${sub}" onchange="setSSOSubSubFilter('${sub}')" class="peer sr-only" />
              <div class="px-2 py-1.5 rounded border border-slate-200 hover:bg-slate-50 peer-checked:text-nadi peer-checked:border-nadi peer-checked:bg-blue-50 text-center transition-all flex items-center justify-center">
                <span class="text-[9px] font-bold uppercase">${sub}</span>
              </div>
            </label>
          `).join("");
          currentSSOSubSubFilter = subMap[subFilter][0] || "";
          document.querySelector('input[name="ssoSubSubFilter"]')?.click();
        } else {
          ssoSubSubFilter.classList.add("hidden");
          currentSSOSubSubFilter = "";
        }
        
        renderAnnouncementList();
      }
      
      function setSSOSubSubFilter(subSubFilter) {
        currentSSOSubSubFilter = subSubFilter;
        
        document.querySelectorAll('input[name="ssoSubSubFilter"]').forEach((radio) => {
          if (radio.value === subSubFilter) {
            radio.checked = true;
          }
        });
        
        renderAnnouncementList();
      }

      function markAnnouncementsReadLocal() {
        if (!Array.isArray(announcements) || announcements.length === 0) return;
        const latestAnnouncement = announcements.reduce((latest, ann) => {
          const annDate = new Date(ann.created_at || ann.createdAt || 0);
          const latestDate = latest ? new Date(latest.created_at || latest.createdAt || 0) : new Date(0);
          return annDate > latestDate ? ann : latest;
        }, null);
        if (!latestAnnouncement) return;
        try {
          announcementStorage.setItem("lastReadAnnouncementId", String(latestAnnouncement.id));
        } catch (error) {}
      }

      function renderAnnouncementList() {
        const container = document.getElementById("announcementListContainer");
        if (!container) return;
        announcementImageMap = {};
        const filter = currentAnnouncementFilter;
        let filtered = announcements;
        
        if (filter === "Urgent") {
          filtered = announcements.filter((a) => a.isUrgent);
        } else if (filter === "SSO") {
          filtered = announcements.filter((a) => a.category === "SSO");
          if (currentSSOSubFilter) {
            filtered = filtered.filter((a) => a.ssoMain === currentSSOSubFilter);
            if (currentSSOSubSubFilter) {
              filtered = filtered.filter((a) => a.ssoSub === currentSSOSubSubFilter);
            }
          }
        } else if (filter !== "all") {
          filtered = announcements.filter((a) => a.category === filter);
        }

        // Apply search filter
        if (announcementSearchQuery) {
          filtered = filtered.filter((ann) => {
            const searchText = announcementSearchQuery.toLowerCase();
            return (
              (ann.title && ann.title.toLowerCase().includes(searchText)) ||
              (ann.content && ann.content.toLowerCase().includes(searchText)) ||
              (ann.category && ann.category.toLowerCase().includes(searchText)) ||
              (ann.ssoMain && ann.ssoMain.toLowerCase().includes(searchText)) ||
              (ann.ssoSub && ann.ssoSub.toLowerCase().includes(searchText))
            );
          });
        }

        filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        if (!filtered || filtered.length === 0) {
          const emptyMessage = announcementSearchQuery
            ? '<div class="text-center py-12"><div class="text-slate-300 text-4xl mb-3"><i class="fa-solid fa-magnifying-glass"></i></div><p class="text-slate-500 text-sm">No announcements found for "' + escapeHtml(announcementSearchQuery) + '"</p></div>'
            : '<div class="text-center py-12"><div class="text-slate-300 text-4xl mb-3"><i class="fa-regular fa-calendar-xmark"></i></div><p class="text-slate-500 text-sm">No announcements yet</p></div>';
          container.innerHTML = emptyMessage;
          return;
        }
          container.innerHTML = filtered.map((ann) => {
          const { date: createdDateStr, time: createdTimeStr } = formatDateStr(ann.created_at);
          const isUrgent = ann.isUrgent || ann.category === "Urgent";
          const dueDisplay = ann.dueDate ? `<span class="inline-flex items-center gap-1 text-red-600 font-bold text-[9px] bg-red-50 px-2 py-1 rounded"><i class="fa-regular fa-clock"></i> Due: ${formatDueDate(ann.dueDate, ann.dueTime)}</span>` : "";
          const urgentBadge = isUrgent ? '<span class="inline-block bg-red-500 text-white text-[9px] font-bold px-2 py-0.5 rounded">URGENT</span>' : "";
          
          let topLeftLabel = "";
          let bottomLeftLabel = "";
          const categoryValue = ann.category;
          
          if (categoryValue === "SSO") {
            const catColors = {
              "Usahawan": { bg: "bg-yellow-100", text: "text-yellow-700", border: "border-yellow-200" },
              "Kesejahteraan Kendiri": { bg: "bg-emerald-100", text: "text-emerald-700", border: "border-emerald-200" },
              "Kesedaran": { bg: "bg-violet-100", text: "text-violet-700", border: "border-violet-200" },
              "Inisiatif Kerajaan": { bg: "bg-red-100", text: "text-red-700", border: "border-red-200" },
              "Pembelajaran Sepanjang Hayat": { bg: "bg-blue-100", text: "text-blue-700", border: "border-blue-200" },
            };
            const colors = catColors[ann.ssoMain] || catColors["Usahawan"];
            const ssoLabel = `<span class="inline-flex items-center gap-1 text-[8px] font-bold px-2 py-0.5 rounded text-left ${colors.bg} ${colors.text} border ${colors.border}">${ann.ssoMain}</span>`;
            const ssoSubLabel = ann.ssoSub ? `<span class="text-[8px] ${colors.text} font-semibold ml-1">${ann.ssoSub}</span>` : "";
            topLeftLabel = `<div class="mb-[10px] flex items-center gap-1 justify-start"><span class="inline-flex items-center gap-1 text-[8px] font-bold px-2 py-0.5 rounded uppercase text-left" style="background-color: #2228a4; color: white;">SSO</span>${ssoLabel}${ssoSubLabel}</div>`;
            bottomLeftLabel = ``;
          } else if (categoryValue === "Urgent" || categoryValue === "urgent") {
            topLeftLabel = `<div class="mb-[10px] justify-start"><span class="inline-flex items-center gap-1 text-[8px] font-bold px-2 py-0.5 rounded uppercase text-left" style="background-color: #dc2626; color: white;">URGENT</span></div>`;
            bottomLeftLabel = ``;
          } else if (categoryValue === "Maxis" || categoryValue === "maxis") {
            topLeftLabel = `<div class="mb-[10px] justify-start"><span class="inline-flex items-center gap-1 text-[8px] font-bold px-2 py-0.5 rounded uppercase text-left" style="background-color: #46c910; color: white;">MAXIS</span></div>`;
          } else if (categoryValue === "Samudra" || categoryValue === "samudra") {
            topLeftLabel = `<div class="mb-[10px] justify-start"><span class="inline-flex items-center gap-1 text-[8px] font-bold px-2 py-0.5 rounded uppercase text-left" style="background-color: #94237a; color: white;">SAMUDRA</span></div>`;
          } else if (categoryValue === "TP" || categoryValue === "tp") {
            topLeftLabel = `<div class="mb-[10px] justify-start"><span class="inline-flex items-center gap-1 text-[8px] font-bold px-2 py-0.5 rounded uppercase text-left" style="background-color: #f97316; color: white;">TP</span></div>`;
          } else {
            if (window.DEBUG_MODE) console.log("Unknown category:", categoryValue);
            topLeftLabel = `<div class="mb-[10px] justify-start"><span class="inline-flex items-center gap-1 text-[8px] font-bold px-2 py-0.5 rounded uppercase text-left" style="background-color: #94a3b8; color: white;">${categoryValue || 'Unknown'}</span></div>`;
          }

          const imageItems = announcementImagesEnabled ? normalizeAnnouncementImages(ann.images) : [];
          announcementImageMap[ann.id] = imageItems.map((img) => ({
            url: img.url,
            name: img.name || "announcement-image"
          }));
          const imagesHtml = imageItems.length > 0
            ? `
              <div class="mt-2 grid grid-cols-3 gap-2">
                ${imageItems.map((img, index) => `
                  <button type="button" onclick="annOpenCardImage('${ann.id}', ${index})" class="block w-full">
                    <div class="w-full h-[130px] flex items-center justify-center bg-slate-50 rounded border border-slate-200 hover:opacity-95 transition-opacity">
                      <img src="${escapeAttribute(img.url)}" alt="Announcement image" class="max-h-[130px] w-full object-contain" loading="lazy" />
                    </div>
                  </button>
                `).join("")}
              </div>
            `
            : "";
          
          return `
            <div class="bg-white border border-slate-200 rounded-xl p-4 hover:shadow-md transition-shadow">
              <div class="flex justify-between items-start">
                <div class="flex-1 pr-2">
                  ${topLeftLabel}
                  <h3 class="text-sm font-bold text-slate-800 leading-tight">${sanitizeHTML(highlightSearchText(ann.title))}</h3>
                  ${bottomLeftLabel}
                </div>
                <div class="flex gap-1.5">
                  <button onclick="annEditAnnouncement('${ann.id}')" class="w-7 h-7 rounded-lg bg-slate-100 hover:bg-blue-50 text-slate-400 hover:text-blue-600 flex items-center justify-center transition-colors"><i class="fa-solid fa-pen text-[10px]"></i></button>
                  <button onclick="annShowDeleteModal('${ann.id}')" class="w-7 h-7 rounded-lg bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-600 flex items-center justify-center transition-colors"><i class="fa-solid fa-trash text-[10px]"></i></button>
                </div>
              </div>
              <div class="text-xs text-black mt-2 leading-relaxed bg-slate-50 border border-slate-100 rounded-lg px-3 py-2 break-all overflow-hidden ann-content-break" style="font-size: 11px;">${ann.content ? sanitizeHTMLWithLinks(convertBoldSyntax(highlightSearchText(ann.content))) : ""}</div>
              ${imagesHtml}
              <div class="pt-2 border-t border-slate-100 mt-3">
                <div class="flex justify-between items-end">
                  ${dueDisplay ? `<div>${dueDisplay}</div>` : '<div></div>'}
                  <div class="flex flex-col items-end">
                    <span class="text-[7px] text-slate-400 uppercase font-bold">Created at:</span>
                    <span class="text-[8px] text-slate-400">${createdTimeStr}, ${createdDateStr}</span>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("");
        markAnnouncementsReadLocal();
      }

      async function annSaveAnnouncement() {
        const title = document.getElementById("announcementTitle").value.trim();
        const content = document.getElementById("announcementEditor").innerHTML.trim();
        const dueDate = document.getElementById("announcementDueDate").value;
        const saveCategory = document.querySelector('input[name="annCategory"]:checked')?.value;
        const saveSSOMain = document.querySelector('input[name="ssoCategory"]:checked')?.value;
        const saveSSOSub = document.querySelector('input[name="ssoSubCategory"]:checked')?.value;

        const isUrgent = saveCategory === "Urgent";

        if (!title || !content || !saveCategory) {
          alert("Please fill in title, content, and select a category!");
          return;
        }

        const announcementData = {
          title: title,
          content: content,
          category: saveCategory,
          ssoMain: saveSSOMain || "",
          ssoSub: saveSSOSub || "",
          dueDate: dueDate || "",
          isUrgent: isUrgent
        };

        try {
          if (annEditingId) {
            let imagesToSave = [];
            if (announcementImagesEnabled) {
              const uploadedImages = annNewImageFiles.length > 0
                ? await uploadAnnouncementImages(annEditingId, annNewImageFiles)
                : [];
              imagesToSave = annExistingImages.concat(uploadedImages);
              announcementData.images = imagesToSave;
            }

            const { data: updatedData, error } = await supabaseClient
              .from('announcements')
              .update(announcementData)
              .eq('id', annEditingId)
              .select();

            if (error) throw error;

            const index = announcements.findIndex((a) => a.id === annEditingId);
            if (index !== -1 && updatedData && updatedData.length > 0) {
              announcements[index] = updatedData[0];
            }

            if (announcementImagesEnabled && annRemovedImages.length > 0) {
              await deleteAnnouncementImages(annRemovedImages);
            }

            annEditingId = null;
          } else {
            if (announcementImagesEnabled && annNewImageFiles.length > 0) {
              const { data: insertedData, error } = await supabaseClient
                .from('announcements')
                .insert([announcementData])
                .select();

              if (error) throw error;

              if (insertedData && insertedData.length > 0) {
                const inserted = insertedData[0];
                const uploadedImages = await uploadAnnouncementImages(inserted.id, annNewImageFiles);
                if (uploadedImages.length > 0) {
                  const { data: updatedData, error: updateError } = await supabaseClient
                    .from('announcements')
                    .update({ images: uploadedImages })
                    .eq('id', inserted.id)
                    .select();

                  if (updateError) throw updateError;

                  if (updatedData && updatedData.length > 0) {
                    announcements.unshift(updatedData[0]);
                  } else {
                    inserted.images = uploadedImages;
                    announcements.unshift(inserted);
                  }
                } else {
                  inserted.images = [];
                  announcements.unshift(inserted);
                }
              }
            } else {
              if (announcementImagesEnabled) {
                announcementData.images = annExistingImages;
              }
              const { data: insertedData, error } = await supabaseClient
                .from('announcements')
                .insert([announcementData])
                .select();

              if (error) throw error;

              if (insertedData && insertedData.length > 0) {
                announcements.unshift(insertedData[0]);
              }
            }
          }
        } catch (err) {
          console.error("Failed to save announcement:", err);
          if (announcementImagesEnabled && /bucket|storage/i.test(err?.message || "")) {
            alert("Image upload failed. Please check the Supabase storage bucket.");
          } else {
          alert("Failed to save announcement. Please try again.");
          }
          return;
        }
        
        annHideAddForm();
        renderAnnouncementList();
      }

      async function annDeleteAnnouncement(id) {
        try {
          if (announcementImagesEnabled) {
            const ann = announcements.find((a) => a.id === id);
            const imagesToRemove = ann ? normalizeAnnouncementImages(ann.images) : [];
            if (imagesToRemove.length > 0) {
              await deleteAnnouncementImages(imagesToRemove);
            }
          }
          // Delete from separate announcements table
          const { error } = await supabaseClient
            .from('announcements')
            .delete()
            .eq('id', id);
          
          if (error) throw error;
          
          // Remove from local array
          announcements = announcements.filter((a) => a.id !== id);
          renderAnnouncementList();
        } catch (err) {
          console.error("Failed to delete announcement:", err);
          alert("Failed to delete announcement. Please try again.");
          return;
        }
        
        renderAnnouncementList();
      }

      function annEditAnnouncement(id) {
        const ann = announcements.find((a) => a.id === id);
        if (!ann) return;
        annEditingId = id;
        annShowAddForm();
        document.getElementById("announcementTitle").value = ann.title;
        document.getElementById("announcementEditor").innerHTML = ann.content || "";
        document.getElementById("announcementEditor").style.fontSize = "12px";
        const categoryToSelect = ann.category === "Urgent" ? "Urgent" : ann.category || "all";
        const catRadio = document.querySelector(`input[name="annCategory"][value="${categoryToSelect}"]`);
        if (catRadio) catRadio.checked = true;
        annCategoryChanged();
        if (ann.ssoMain) {
          const radio = document.querySelector(`input[name="ssoCategory"][value="${ann.ssoMain}"]`);
          if (radio) radio.checked = true;
          annSSOMainChanged();
          setTimeout(() => {
            const subRadio = document.querySelector(`input[name="ssoSubCategory"][value="${ann.ssoSub}"]`);
            if (subRadio) subRadio.checked = true;
          }, 50);
        }
        document.getElementById("announcementDueDate").value = ann.dueDate || "";
        if (announcementImagesEnabled) {
          annExistingImages = normalizeAnnouncementImages(ann.images);
          annRemovedImages = [];
          annNewImageFiles = [];
          renderAnnouncementImagePreviews();
        }
      }

      document.addEventListener("DOMContentLoaded", async function() {
        setAnnouncementImagesEnabled(true);
        setAnnouncementFilter("all");
        
        // Load announcements from Supabase
        try {
          let { data: announcementsData, error } = await supabaseClient
            .from('announcements')
            .select('id,title,content,category,ssoMain,ssoSub,dueDate,isUrgent,created_at,images');

          if (error && isMissingColumnError(error)) {
            setAnnouncementImagesEnabled(false);
            const fallback = await supabaseClient
              .from('announcements')
              .select('id,title,content,category,ssoMain,ssoSub,dueDate,isUrgent,created_at');
            announcementsData = fallback.data;
            error = fallback.error;
          }
          
          if (error) {
            console.error("Error loading announcements:", error);
          } else {
            announcements = announcementsData || [];
            if (!Array.isArray(announcements)) {
              announcements = [];
            }
            renderAnnouncementList();
          }
        } catch (err) {
          console.error("Failed to load announcements:", err);
        }
        
        // Auto-convert pasted URLs to clickable links while preserving formatting
        const editor = document.getElementById("announcementEditor");
        if (editor) {
          editor.addEventListener("paste", function(e) {
            e.preventDefault();

            // Get both HTML and plain text from clipboard
            const html = e.clipboardData.getData("text/html");
            const text = e.clipboardData.getData("text/plain");

            if (html) {
              // Parse the HTML
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, "text/html");

              // Function to convert URLs in text nodes while preserving URL encoding
              const convertUrls = (node) => {
                if (node.nodeType === Node.TEXT_NODE) {
                  // Match URLs with protocol and domain-only URLs (e.g., dilea.nadi.my)
                  const urlRegex = /(https?:\/\/[^\s<"]+)|((?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}(?:\/[^\s<"]*)?)/gi;
                  const newHtml = node.textContent.replace(urlRegex, function(url, fullUrl, domainUrl) {
                    // If matched domain-only URL, prepend https://
                    if (domainUrl) {
                      url = "https://" + domainUrl;
                    }
                    // Escape the URL before using it in href to preserve encoding
                    const escapedUrl = url.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    return `<a href="${escapedUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">${escapedUrl}</a>`;
                  });
                  if (newHtml !== node.textContent) {
                    const span = document.createElement("span");
                    span.innerHTML = newHtml;
                    node.parentNode.replaceChild(span, node);
                  }
                } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName !== "A") {
                  // Recursively process child nodes
                  Array.from(node.childNodes).forEach(child => convertUrls(child));
                }
              };

              // Process the body content
              convertUrls(doc.body);

              // Get the processed HTML
              let processedHtml = doc.body.innerHTML;

              // Clean up empty paragraphs and fix spacing
              processedHtml = processedHtml
                .replace(/<p>\s*<\/p>/g, "")
                .replace(/<p>\s*/g, "<p>")
                .replace(/\s*<\/p>/g, "</p>")
                .replace(/<br>\s*/g, "<br>")
                .replace(/\s*<br>/g, "<br>");

              // Insert the HTML
              document.execCommand("insertHTML", false, processedHtml);
            } else if (text) {
              // Plain text - preserve line breaks
              const urlRegex = /(https?:\/\/[^\s<"]+)|((?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}(?:\/[^\s<"]*)?)/gi;
              let processedText = text.replace(urlRegex, function(url, fullUrl, domainUrl) {
                // If matched domain-only URL, prepend https://
                if (domainUrl) {
                  url = "https://" + domainUrl;
                }
                // Escape the URL before using it in href to preserve encoding
                const escapedUrl = url.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                return `<a href="${escapedUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">${escapedUrl}</a>`;
              });

              // Convert line breaks to <br> or <p> tags
              const paragraphs = processedText.split(/\n\n+/);
              const htmlParagraphs = paragraphs.map(p => {
                const lines = p.split(/\n/);
                return "<p>" + lines.map(line => line.trim()).join("<br>") + "</p>";
              }).join("");

              document.execCommand("insertHTML", false, htmlParagraphs);
            }
          });
        }
      });
    </script>
  </body>
</html>
